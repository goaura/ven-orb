description: >
  Deploys code and infrastructure

executor: default

parameters:
  stage:
    type: string
    description: "Stage to run commands against"
  fingerprint:
    type: string
    description: "CircleCI SSH Fingerprint"
  fmt:
    type: boolean
    default: false
    description: "Run 'ven fmt' command"
  test:
    type: boolean
    default: false
    description: "Run 'ven test' command"
  init:
    type: boolean
    default: false
    description: "Run 'ven init' command"
  deploy-consumers:
    type: boolean
    default: false
    description: "Run 'ven deploy consumers' command"
  deploy-infrastructure:
    type: boolean
    default: false
    description: "Run 'ven deploy infrastructure' command"
  deploy-service:
    type: boolean
    default: false
    description: "Run 'ven deploy service' command"
steps:
  - checkout
  - add_ssh_keys:
      fingerprints:
        - << parameters.fingerprint >>
  - install
  - when:
      condition: << parameters.fmt >>
      steps:
        - fmt
  - when:
      condition: << parameters.init >>
      steps:
        - init:
            stage: << parameters.stage >>
  - when:
      condition: << parameters.test >>
      steps:
        - test
  - when:
      condition: << parameters.deploy-consumers >>
      steps:
        - deploy-consumers:
            stage: << parameters.stage >>
  - when:
      condition: << parameters.deploy-infrastructure >>
      steps:
        - deploy-infrastructure:
            stage: << parameters.stage >>
  - when:
      condition: << parameters.deploy-service >>
      steps:
        - setup_remote_docker
            version: '20.10.2'
        - deploy-service:
            stage: << parameters.stage >>
